---
title: "HW2. Hypothesis testing"
output: html_document
---

# HW2. Тестирование гипотез. t-test. Доверительные интервалы. Корреляции 

Перед сдачей домашнего задания рекомендуем запустить Run All или сгенерировать html- или pdf-страницу с помощью Knit, чтобы убедиться, что в финальной версии весь ваш код будет запускаться без проблем.

Файл Rmd вы можете а) положить в свой приватный репозиторий da4clcourse на GitHub (в корне репозитория под именем HW1.Rmd). Дайте доступ преподавателю и ассистенту к приватному репозиторию (пригласите @olesar и @The-One-Who-Speaks-and-Depicts) или б) выслать преподавателю на почту olyashevskaya@hse.ru с темой da4clcourse.

## 1. Частотность и фонетика

В этом разделе используются те же данные, что и в прошлом домашнем задании. Вы можете пропустить описание, если знакомы с датасетом.  

Во многих лингвистических исследованиях отмечается, что часто используемые в языке слова звучат короче, а при их произнесении наблюдается редукция и коартикуляция. Работа Fabian Tomaschek et al. (2018) исследует гипотезу, что моторные навыки произнесения улучшаются с опытом, который, в свою очередь, напрямую связан с частотностью слова. Ученые попросили испытуемых (17 бакалавров университета Тюбингена, 8 мужчин и 9 женщин) прочитать вслух немецкие глаголы, содержащие звук [a:] в основе. Испытуемые были поставлены в экспериментальные условия, которые исподволь заставляли их читать быстрее или медленнее (slow/fast condition).

В этом задании мы просим вас сравнить длину звучания всего слова целиком, а также длину звучания интересующего ученых сегмента (звука [a:]) в условиях slow и fast. Хотя логично предположить, что в условии fast произнесение и слов, и сегментов будет короче, все же нужно убедиться, что данные это подтверждают, прежде чем переходить к более сложному анализу по сути вопроса. Кроме того, мы будем уверены, что экспериментальные условия были должным образом соблюдены, ученые не запутались в кодировании данных и документировали результаты корректно.

Интересующие нас переменные:

LogDurationW - log-transformed word duration (логарифм длины произнесения слова)
LogDurationA - log-transformed segment duration (логарифм длины произнесения сегмента)
Cond - condition: slow vs. fast (условие).

Ссылка на данные [link](https://raw.githubusercontent.com/LingData2019/LingData2020/master/data/dur_word_frequency.csv)

### 1.0 t-test

С помощью t-критерия Стьюдента мы хотим определить статистическую значимость различия значений применительно к следующим переменным:  

(a) word duration in fast condition and word duration in slow condition,

(b) segment duration in fast condition and segment duration in slow condition. 

Другими словами, мы хотим проверить, что различие этих длительностей имеет место не только на выборках, но и в генеральной совокупности.

#### 1.1a Гипотезы 

В первую очередь, сформулируйте нулевую гипотезу (H_0) и альтернативную гипотезу (H_1). Если для выполнения задания нужно сформулировать несколько H_0 и H_1, сделайте это, продублировав этот и следующий разделы (1.1а, 1.2a, 1.3.a, 1.1b, 1.2b и т.д.)  

```
H0: word duration in fast == word duration in slow

H1: word duration in fast < word duration in slow
```

#### 1.2a Тест  

Загрузите данные и примените `t.test` для проверки гипотез.  

```{r t-test}
library(dplyr)
library(tidyverse)
data <- read.csv('https://raw.githubusercontent.com/LingData2019/LingData2020/master/data/dur_word_frequency.csv')
fast_word <- data %>%
  filter(Cond == 'fast') %>%
  select('LogDurationW')
fast_word
slow_word <- data %>%
  filter(Cond == 'slow') %>%
  select('LogDurationW')
slow_word
t.test(x=fast_word, y=slow_word,
       alternative='less', conf.level=0.95,
       var.equal=TRUE)
```

#### 1.1b Гипотезы 

```
H0: segment duration in fast == segment duration in slow

H1: segment duration in fast < segment duration in slow
```

#### 1.2b Тест  

Загрузите данные и примените `t.test` для проверки гипотез.  

```{r t-test}
data <- read.csv('https://raw.githubusercontent.com/LingData2019/LingData2020/master/data/dur_word_frequency.csv')
fast_seg <- data %>%
  filter(Cond == 'fast') %>%
  select('LogDurationA')
fast_seg
slow_seg <- data %>%
  filter(Cond == 'slow') %>%
  select('LogDurationA')
slow_seg
t.test(x=fast_seg, y=slow_seg,
       alternative='less', conf.level=0.95,
       var.equal=TRUE)
```


#### 1.3 Интерпретация  

Интерпретируйте результаты t-теста. Включите в вывод t-статистику, степени свободы и p-values. Можно ли заключить, что имеется различие в длительности слов в быстрых и медленных условиях в генеральной совокупности? Можно ли заключить то же самое в отношении длительности сегментов?  

```
T-тест относительно длительности слов показал следующие результаты:
(t=-11.525, df=830, p-value < 2.2e-16) 

T-статистика имеет большое отрицательное значение, что свидетельствует о том, что среднее значение длительности слов в быстрых условиях значительно ниже, чем в медленных. 
P-value также сильно ниже 0,05, что подтверждает идею о статистически значимом различии между длительностью слов в быстрых и медленных условиях. 
Высокие степени свободы показывают, что выборка примеров длительности слов большая, а значит выводы, которые можно сделать на ее основе, будут корректными. 

Исходя из данных t-теста для переменных (а) можно заключить, что различие в длительности слов в быстрых и медленных условиях в генеральной совокупности имеется и оно довольно значимое. 

T-тест относительно длительности сегментов показал следующие результаты:
(t=-7.5141, df=830, p-value = 7.419e-14)

T-статистика имеет большое отрицательное значение, что свидетельствует о том, что среднее значение длительности сегментов в быстрых условиях значительно ниже, чем в медленных. 
P-value еще ниже 0,05, чем в тесте по длительности слов, что подтверждает идею о статистически значимом различии между длительностью сегментов в быстрых и медленных условиях. 
Высокие степени свободы показывают, что выборка примеров длительности сегментов большая, а значит выводы, которые можно сделать на ее основе, будут корректными. 

Исходя из данных t-теста для переменных (b) можно заключить, что различие в длительности сегментов в быстрых и медленных условиях в генеральной совокупности имеется.
```

### 2. Дискуссия 

Возможно, применение t-test в чистом виде является не лучшей опцией для решения задачи 1.0. Если вам тоже так кажется, приведите аргументы против его использования и предложите другое решение. 

```
Я согласен, в чистом виде применение t-test не учитывается, например, взаимозависимость значений в определенных ситуациях (произнесение одним и тем же человеком). 
Для более точных результатов лучше применить непараметрический тест, например, тест Манна-Уитни. 
```

#### 2.1 Код для решения    

Напишите код, который может помочь в аргументации и покажет другое решение. 

```{r} 
wilcox.test(LogDurationW ~ Cond, data = data, paired = FALSE)
wilcox.test(LogDurationA ~ Cond, data = data, paired = FALSE)
```


### 3. Доверительный интервал

#### 3.1 Формула в явном виде 

Ниже приведена формула для вычисления 95% доверительного интервала:

$$
\mathrm{CI} = \left[\bar{x} - 1.96\times \frac{\mathop{\mathrm{sd}}(x)}{\sqrt{n}},\ \bar{x} + 1.96\times \frac{\mathop{\mathrm{sd}}(x)}{\sqrt{n}}\right].
$$
Используйте ее для нахождения 95% доверительного интервала для популяционной средней длительности слова (средней в генеральной совокупности).  


```{r ci-formula}
x <- data %>%
  pull('LogDurationW')
x_mean <- mean(x)
x_mean
sd_x <- sd(x)
n <- length(x)
sqrt_n <- sqrt(n)

CI_low <- (x_mean - 1.96 * (sd_x / sqrt_n))
CI_up <- (x_mean + 1.96 * (sd_x / sqrt_n))

CI <- c(CI_low, CI_up)
CI
```


#### 3.2 Функция `t.test`

Примените функцию `t.test` к той же переменной, чтобы узнать доверительный интервал среднего. 

```{r ci-ttest}
t.test(x)
```

Совпадают ли результаты вычислений в 3.1 и 3.2?

Да, результаты совпадают в пределах 6 знаков после запятой. 


#### 3.3 Другие уровни доверия  

С помощью функции `MeanCI` из пакета `DescTools` найдите 99% доверительный интервал для той же переменнной. Он шире или уже, чем 95% CI?  

Подсказка: используйте аргумент `conf.level`. 

```{r ci-99}
library(DescTools)

MeanCI(x, sd_x, conf.level = 0.99)

```
Доверительный интервал 99% шире, чем 95%. 


## 4. В каком возрасте дети усваивают слова? 

#### Практика в Tydyverse

Data: https://www.kaggle.com/rtatman/when-do-children-learn-words?select=main_data.csv

Основная таблица включает информацию о 732 словах норвежского языка и возрасте их усвоения детьми (age of acquisition). Другая таблица включает дополнительную информацию о частотности слов по данным веб-корпуса (Norwegian Web as Corpus) и данным разговоров взрослых с детьми.

Релевантные переменные (main data):

**Translation**: английский перевод норвежского слова

**AoA**: возраст усвоения в месяцах (в среднем, в каком возрасте слово усваивается детьми)

**VSoA**: сколько других слов знает "обобщенный" ребенок к моменту усвоения данного слова (округленно к ближайшему десятку)

**Broad_lex**: часть речи данного слова (в широком понимании) 

**CDS_Freq**: частота, с которой взрослый-носитель норвежского языка обращается к ребенку

Релевантные переменные (Norwegian CDS Frequency):

**Translation**: английский перевод норвежского слова

**Freq_NoWaC**: частота по данным корпуса NoWaC (интернет-коммуникация)

**Freq_CDS**: частота слова (по материалам двух норвежских корпусов CHILDES) при обращении к ребенку

NB! Все остальные переменные должны быть удалены из данных.  

NB! Столбцы 'Freq_CDS' and 'CDS_Freq' - это одно и то же. 

#### Данные 

#### 4.1 
Прочитайте обе таблицы   

```{r}
main_data <- read.csv("C:\\Users\\nikol\\Downloads\\main_data.csv")
main_data

norw_CDS_freq <- read.csv("C:\\Users\\nikol\\Downloads\\Norwegian_CDS_frequency.csv")
norw_CDS_freq
```

#### 4.2 
Оставьте только необходимые для последующего исследования переменные.

```{r}
main_data <- main_data %>%
  select("Translation", "AoA", "VSoA", "Broad_lex", "CDS_freq")
names(main_data)[names(main_data) == "CDS_freq"] <- "Freq_CDS"
main_data

norw_CDS_freq <- norw_CDS_freq %>%
  select("Translation", "Freq_NoWaC", "Freq_CDS")
norw_CDS_freq
```

#### 4.3  
Объедините две таблицы в общий датафрейм/тиббл под названием 'norw_words'. 

NB! В вашем датафрейме не должно быть дублирования столбцов. 

```{r}
norw_words <- left_join(main_data, norw_CDS_freq)
norw_words
```

#### 4.4  
Оставьте только 15 первых строк 
 
```{r}
norw_words <- norw_words %>%
  slice(0:15)
norw_words
```


#### 5. Преобразования данных 

#### 5.1  
Создайте тиббл 'freq_statistics', используя 3 столбца из (полного) тиббла `norw_words`: 'Translation', 'CDS_Freq', 'Freq_NoWaC'. Затем с помощью функций `pivot_longer`/`pivot_wider` измените формат тиббла с "широкого" на "узкий" или наоборот (данные подскажут вам, с какого на какой менять).

```{r}
freq_statistics <- norw_words %>%
  select(Translation, Freq_CDS, Freq_NoWaC) %>%
  pivot_longer(Freq_CDS:Freq_NoWaC)
freq_statistics
```

#### 5.2  
Получите строковый вектор (string vector output) с информацией о классах переменных в тиббле. 

```{r}
string_v_out <- sapply(freq_statistics, class)
string_v_out
```

#### 5.3  
Представьте ту же информацию как датафрейм (dataframe). 

```{r}
as.data.frame(summary(freq_statistics))
```

#### 5.4  
Конвертируйте значения из столбцов `CDS_Freq` и `Freq_NoWaC` тиббла `freq_statistics` в числовые (numeric). 

```{r}
freq_statistics <- freq_statistics %>%
  pivot_wider()
freq_statistics

freq_statistics$Freq_CDS <- as.numeric(freq_statistics$Freq_CDS)
freq_statistics$Freq_NoWaC <- as.numeric(freq_statistics$Freq_NoWaC)
freq_statistics
```

#### 5.5 
Получите средние значения всех числовых типов переменных в `norw_words`.

```{r}
freq_cds <- freq_statistics %>%
  pull(Freq_CDS)
freq_nowac <- freq_statistics %>%
  pull(Freq_NoWaC)

mean(freq_cds, na.rm = TRUE)
mean(freq_nowac, na.rm = TRUE)
```

#### 5.6 
Создайте вложенную структуру (nested table) по столбцу `Translation`.
 
```{r}
nested_table <- freq_statistics %>%
  group_by(Translation) %>%
  nest(data = c(Freq_CDS, Freq_NoWaC))
nested_table
```

#### 6.1 Корреляционный анализ  

Из доступных данных, выберите несколько переменных (более двух) для проведения корреляционного анализа, визуализируйте тепловую карту или другой тип коррелограммы. 

```{r}
library(corrplot)

data_for_cor <- left_join(main_data, norw_CDS_freq) %>%
  select(AoA, VSoA, Freq_CDS, Freq_NoWaC) %>%
  mutate_all(as.numeric)
print(data_for_cor)

cor_matrix <- cor(data_for_cor, use="complete.obs")
print(cor_matrix)

corrplot(cor_matrix, type = "upper",  
         method = "number",  
         addCoef.col = "black",  
         tl.col = "black", tl.srt = 45)
```
```{r}
cor.mtest <- function(mat, ...) {
    mat <- as.matrix(mat)
    n <- ncol(mat)
    p.mat<- matrix(NA, n, n)
    diag(p.mat) <- 0
    for (i in 1:(n - 1)) {
        for (j in (i + 1):n) {
            tmp <- cor.test(mat[, i], mat[, j], ...)
            p.mat[i, j] <- p.mat[j, i] <- tmp$p.value
        }
    }
  colnames(p.mat) <- rownames(p.mat) <- colnames(mat)
  p.mat
}
p.mat <- cor.mtest(data_for_cor)
p.mat

```


#### 6.2 
Выводы  

В поле ниже сформулируйте ваши выводы, приведите p-values и другие необходимые статистические метрики. 

```
Анализируя коррелограмму, проявляется очевидная взаимосвязь возраста усвоения слова (AoA) и количества слов, которые знает ребенок к моменту усвоения этого слова (VSoA). Из этого можно сделать вывод, что, чем больше слов знает ребенок, тем быстрее он учит другие слова. 

Средняя степень связи прослеживается между частотой слова в языке в целом (Freq_NoWaC) и частотой, с которой взрослый обращается к ребенку, используя это слово (Freq_CDS). Здесь закономерность еще более понятная - чем чаще слово используется в языке вообще, тем чаще его слышит ребенок от взрослых. 

Статистически значимые степени связи между переменными заканчиваются. Переходим к менее выраженным связям. 

Слабая связь наблюдается между частотой слова в языке в целом (Freq_NoWaC), возрастом усвоения слова (AoA) и количеством слов, которые знает ребенок к моменту усвоения этого слова (VSoA). Это совпадает с логической цепочкой мысли: если слово встречается в языке часто, ребенок должен усвоить его за меньшее количество времени. 

Самая слабая связь наблюдается между частотой, с которой взрослый обращается к ребенку, используя слово (Freq_CDS), и возрастом усвоения слова (AoA) и количеством слов, которые знает ребенок к моменту усвоения этого слова (VSoA). Это также имеет смысл: если ребенок часто слышит слово от взрослых, он должен быстро его усвоить. 

По p-values, мы видим высокие (> 0.05) значения для пар FreqCDS с AoA и VSoA, FreqNoWaC с AoA. 

```